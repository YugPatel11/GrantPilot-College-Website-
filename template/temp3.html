new view.py



from django.shortcuts import render, redirect, get_object_or_404
from django.contrib import messages
from .models import Project, ProjectRequest, IPRRequest
from django.contrib.auth import authenticate, login
from django.contrib.auth.decorators import login_required
from django.contrib.auth.models import User, Group
from django.contrib.auth.forms import UserCreationForm


# ---------- STUDENT INTERFACE ----------

def student_signup(request):
    if request.method == 'POST':
        form = UserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            group, _ = Group.objects.get_or_create(name='student')
            user.groups.add(group)
            login(request, user)
            return redirect('student_dashboard')
    else:
        form = UserCreationForm()
    return render(request, 'student/student_signup.html', {'form': form})


def custom_login(request):
    if request.method == 'POST':
        user_type = request.POST.get('userType')
        if user_type == 'student':
            enrollment = request.POST.get('enrollment')
            password = request.POST.get('password')
            user = authenticate(request, username=enrollment, password=password)
        else:
            username = request.POST.get('username')
            password = request.POST.get('password')
            user = authenticate(request, username=username, password=password)

        if user:
            login(request, user)
            return redirect('student_dashboard' if user_type == 'student' else 'college_dashboard')
        else:
            return render(request, 'login.html', {'error': 'Invalid credentials'})

    return render(request, 'login.html')


@login_required
def student_dashboard(request):
    all_projects = Project.objects.all().order_by('-id')
    applied_projects = ProjectRequest.objects.filter(
        leader_email=request.user.email
    ).order_by('-submitted_at')
    return render(request, 'student/student_dashboard.html', {
        'all_projects': all_projects,
        'applied_projects': applied_projects
    })


def apply_project(request):
    projects = Project.objects.all()

    if request.method == 'POST':
        title = request.POST.get('title', '').strip()
        if not title:
            messages.error(request, "Project title is required.")
            return render(request, 'student/apply_project.html', {'projects': projects})

        try:
            ProjectRequest.objects.create(
                title=title,
                description = request.POST.get('description'),
                grant=request.POST.get('grant'),
                domain_of_project=request.POST.get('domain_of_project'),
                no_of_member=request.POST.get('no_of_member') or 1,
                acadamic_year=request.POST.get('acadamic_year'),
                project_completion_time=request.POST.get('project_completion_time'),

                mentor_name=request.POST.get('mentor_name'),
                mentor_email=request.POST.get('mentor_email'),
                mentor_phone=request.POST.get('mentor_phone'),
                mentor_school=request.POST.get('mentor_school'),
                mentor_designation=request.POST.get('mentor_designation'),

                leader_name=request.POST.get('leader_name'),
                leader_email=request.POST.get('leader_email'),
                leader_phone=request.POST.get('leader_phone'),
                leader_school=request.POST.get('leader_school'),
                leader_department=request.POST.get('leader_department'),
                leader_enrollment=request.POST.get('leader_enrollment'),

                member1_name=request.POST.get('member1_name'),
                member1_email=request.POST.get('member1_email'),
                member1_phone=request.POST.get('member1_phone'),
                member1_school=request.POST.get('member1_school'),
                member1_department=request.POST.get('member1_department'),
                member1_enrollment=request.POST.get('member1_enrollment'),

                member2_name=request.POST.get('member2_name'),
                member2_email=request.POST.get('member2_email'),
                member2_phone=request.POST.get('member2_phone'),
                member2_school=request.POST.get('member2_school'),
                member2_department=request.POST.get('member2_department'),
                member2_enrollment=request.POST.get('member2_enrollment'),

                member3_name=request.POST.get('member3_name'),
                member3_email=request.POST.get('member3_email'),
                member3_phone=request.POST.get('member3_phone'),
                member3_school=request.POST.get('member3_school'),
                member3_department=request.POST.get('member3_department'),
                member3_enrollment=request.POST.get('member3_enrollment'),

                member4_name=request.POST.get('member4_name'),
                member4_email=request.POST.get('member4_email'),
                member4_phone=request.POST.get('member4_phone'),
                member4_school=request.POST.get('member4_school'),
                member4_department=request.POST.get('member4_department'),
                member4_enrollment=request.POST.get('member4_enrollment'),
            )
            messages.success(request, "Project request submitted successfully.")
            return redirect('project_list')

        except Exception as e:
            messages.error(request, f"An error occurred: {e}")

    return render(request, 'student/apply_project.html', {'projects': projects})


def apply_ipr(request):
    if request.method == 'POST':
        
        invention_title = request.POST.get('invention_title')
        patent_description = request.POST.get('patent_description')
        no_of_member=request.POST.get('no_of_member') or 1


        mentor_name=request.POST.get('mentor_name')
        mentor_email=request.POST.get('mentor_email')
        mentor_phone=request.POST.get('mentor_phone')
        mentor_school=request.POST.get('mentor_school')
        mentor_designation=request.POST.get('mentor_designation')

        comentor_name=request.POST.get('comentor_name')
        comentor_email=request.POST.get('comentor_email')

        leader_name=request.POST.get('leader_name')
        leader_email=request.POST.get('leader_email')
        leader_phone=request.POST.get('leader_phone')
        leader_school=request.POST.get('leader_school')
        leader_department=request.POST.get('leader_department')
        leader_enrollment=request.POST.get('leader_enrollment')
        leader_current_semester=request.POST.get('leader_current_semester')

        member1_name=request.POST.get('member1_name')
        member1_email=request.POST.get('member1_email')
        member1_phone=request.POST.get('member1_phone')
        member1_school=request.POST.get('member1_school')
        member1_department=request.POST.get('member1_department')
        member1_enrollment=request.POST.get('member1_enrollment')
        member1_current_semester=request.POST.get('member1_current_semester')
         
        member2_name=request.POST.get('member2_name')
        member2_email=request.POST.get('member2_email')
        member2_phone=request.POST.get('member2_phone')
        member2_school=request.POST.get('member2_school')
        member2_department=request.POST.get('member2_department')
        member2_enrollment=request.POST.get('member2_enrollment')
        member2_current_semester=request.POST.get('member2_current_semester')

        member3_name=request.POST.get('member3_name')
        member3_email=request.POST.get('member3_email')
        member3_phone=request.POST.get('member3_phone')
        member3_school=request.POST.get('member3_school')
        member3_department=request.POST.get('member3_department')
        member3_enrollment=request.POST.get('member3_enrollment')
        member3_current_semester=request.POST.get('member3_current_semester')

        member4_name=request.POST.get('member4_name')
        member4_email=request.POST.get('member4_email')
        member4_phone=request.POST.get('member4_phone')
        member4_school=request.POST.get('member4_school')
        member4_department=request.POST.get('member4_department')
        member4_enrollment=request.POST.get('member4_enrollment')
        member4_current_semester=request.POST.get('member4_current_semester')

        IPRRequest.objects.create(
            
            invention_title=invention_title,
            patent_description=patent_description,
            no_of_member=no_of_member,

            mentor_name=mentor_name,
            mentor_email=mentor_email,
            mentor_phone=mentor_phone,
            mentor_school=mentor_school,
            mentor_designation=mentor_designation,

            comentor_name=comentor_name,
            comentor_email=comentor_email,

            leader_name=leader_name,
            leader_email=leader_email,
            leader_phone=leader_phone,
            leader_school=leader_school,
            leader_department=leader_department,
            leader_enrollment=leader_enrollment,
            leader_current_semester=leader_current_semester,

            member1_name=member1_name,
            member1_email=member1_email,
            member1_phone=member1_phone,
            member1_school=member1_school,
            member1_department=member1_department,
            member1_enrollment=member1_enrollment,
            member1_current_semester=member1_current_semester,

            member2_name=member2_name,
            member2_email=member2_email,
            member2_phone=member2_phone,
            member2_school=member2_school,
            member2_department=member2_department,
            member2_enrollment=member2_enrollment,
            member2_current_semester=member2_current_semester,
            
            member3_name=member3_name,
            member3_email=member3_email,
            member3_phone=member3_phone,
            member3_school=member3_school,
            member3_department=member3_department,
            member3_enrollment=member3_enrollment,
            member3_current_semester=member3_current_semester,

            member4_name=member4_name,
            member4_email=member4_email,
            member4_phone=member4_phone,
            member4_school=member4_school,
            member4_department=member4_department,
            member4_enrollment=member4_enrollment,
            member4_current_semester=member4_current_semester,


        )
        messages.success(request, 'Your IPR request has been submitted.')
        return redirect('project_list')

    return render(request, 'student/apply_ipr.html')

# ---------- COLLEGE INTERFACE ----------

@login_required
def college_dashboard(request):
    projects = Project.objects.all().order_by('-id')
    return render(request, 'college/college_dashboard.html', {'projects': projects})


def project_detail(request, pk):
    project = get_object_or_404(Project, pk=pk)
    return render(request, 'college/project_details.html', {'project': project})


@login_required
def add_edit_project(request, pk=None):
    project = get_object_or_404(Project, pk=pk) if pk else None

    if request.method == 'POST':
        title = request.POST.get('title')
        description = request.POST.get('description')
        grant = request.POST.get('grant')
        no_of_member = request.POST.get('no_of_member')
        domain_of_project = request.POST.get('domain_of_project')
        acadamic_year = request.POST.get('acadamic_year')
        project_completion_time = request.POST.get('project_completion_time')

        mentor_name = request.POST.get('mentor_name')
        mentor_email = request.POST.get('mentor_email')
        mentor_phone = request.POST.get('mentor_phone')
        mentor_school = request.POST.get('mentor_school')
        mentor_designation = request.POST.get('mentor_designation')

        leader_name = request.POST.get('leader_name')
        leader_email = request.POST.get('leader_email')
        leader_phone = request.POST.get('leader_phone')
        leader_department = request.POST.get('leader_department')
        leader_school = request.POST.get('leader_school')
        leader_enrollment = request.POST.get('leader_enrollment')

        member1_name = request.POST.get('member1_name')
        member1_email = request.POST.get('member1_email')
        member1_phone = request.POST.get('member1_phone')
        member1_department = request.POST.get('member1_department')
        member1_school = request.POST.get('member1_school')
        member1_enrollment = request.POST.get('member1_enrollment')

        member2_name = request.POST.get('member2_name')
        member2_email = request.POST.get('member2_email')
        member2_phone = request.POST.get('member2_phone')
        member2_department = request.POST.get('member2_department')
        member2_school = request.POST.get('member2_school')
        member2_enrollment = request.POST.get('member2_enrollment')

        member3_name = request.POST.get('member3_name')
        member3_email = request.POST.get('member3_email')
        member3_phone = request.POST.get('member3_phone')
        member3_department = request.POST.get('member3_department')
        member3_school = request.POST.get('member3_school')
        member3_enrollment = request.POST.get('member3_enrollment')

        member4_name = request.POST.get('member4_name')
        member4_email = request.POST.get('member4_email')
        member4_phone = request.POST.get('member4_phone')
        member4_department = request.POST.get('member4_department')
        member4_school = request.POST.get('member4_school')
        member4_enrollment = request.POST.get('member4_enrollment')

        if project:
            # Update existing
            project.title = title
            project.description = description
            project.grant = grant
            project.no_of_member = no_of_member
            project.domain_of_project = domain_of_project
            project.acadamic_year = acadamic_year
            project.project_completion_time = project_completion_time

            project.mentor_name = mentor_name
            project.mentor_email = mentor_email
            project.mentor_phone = mentor_phone
            project.mentor_school = mentor_school
            project.mentor_designation = mentor_designation

            project.leader_name = leader_name
            project.leader_email = leader_email
            project.leader_phone = leader_phone
            project.leader_department = leader_department
            project.leader_school = leader_school
            project.leader_enrollment = leader_enrollment

            project.member1_name = member1_name
            project.member1_email = member1_email
            project.member1_phone = member1_phone
            project.member1_department = member1_department
            project.member1_school = member1_school
            project.member1_enrollment = member1_enrollment

            project.member2_name = member2_name
            project.member2_email = member2_email
            project.member2_phone = member2_phone
            project.member2_department = member2_department
            project.member2_school = member2_school
            project.member2_enrollment = member2_enrollment

            project.member3_name = member3_name
            project.member3_email = member3_email
            project.member3_phone = member3_phone
            project.member3_department = member3_department
            project.member3_school = member3_school
            project.member3_enrollment = member3_enrollment

            project.member4_name = member4_name
            project.member4_email = member4_email
            project.member4_phone = member4_phone
            project.member4_department = member4_department
            project.member4_school = member4_school
            project.member4_enrollment = member4_enrollment

            project.save()
            messages.success(request, 'Project updated successfully.')
        else:
            # Create new
            Project.objects.create(
                title=title,
                description=description,
                grant=grant,
                no_of_member=no_of_member,
                domain_of_project=domain_of_project,
                acadamic_year=acadamic_year,
                project_completion_time=project_completion_time,
                mentor_name=mentor_name,
                mentor_email=mentor_email,
                mentor_phone=mentor_phone,
                mentor_school=mentor_school,
                mentor_designation=mentor_designation,
                leader_name=leader_name,
                leader_email=leader_email,
                leader_phone=leader_phone,
                leader_department=leader_department,
                leader_school=leader_school,
                leader_enrollment=leader_enrollment,
                member1_name=member1_name,
                member1_email=member1_email,
                member1_phone=member1_phone,
                member1_department=member1_department,
                member1_school=member1_school,
                member1_enrollment=member1_enrollment,
                member2_name=member2_name,
                member2_email=member2_email,
                member2_phone=member2_phone,
                member2_department=member2_department,
                member2_school=member2_school,
                member2_enrollment=member2_enrollment,
                member3_name=member3_name,
                member3_email=member3_email,
                member3_phone=member3_phone,
                member3_department=member3_department,
                member3_school=member3_school,
                member3_enrollment=member3_enrollment,
                member4_name=member4_name,
                member4_email=member4_email,
                member4_phone=member4_phone,
                member4_department=member4_department,
                member4_school=member4_school,
                member4_enrollment=member4_enrollment,
            )
            messages.success(request, 'Project added successfully.')

        return redirect('college_dashboard')

    return render(request, 'college/add_edit_project.html', {'project': project})



@login_required
def student_requests(request):
    project_requests = ProjectRequest.objects.all().order_by('-submitted_at')
    ipr_requests = IPRRequest.objects.all().order_by('-submitted_at')
    return render(request, 'college/student_requests.html', {
        'project_requests': project_requests,
        'ipr_requests': ipr_requests,
    })


def college_login_view(request):
    if request.method == "POST":
        username = request.POST.get("username")
        password = request.POST.get("password")
        user = authenticate(request, username=username, password=password)
        if user:
            login(request, user)
            return redirect("college_dashboard")
        else:
            return render(request, "college_login.html", {"error": "Invalid credentials"})
    return render(request, "college_login.html")


@login_required
def delete_project(request, pk):
    project = get_object_or_404(Project, pk=pk)
    if request.method == "POST":
        project.delete()
        return redirect('college_dashboard')


@login_required
def request_detail(request, type, request_id):
    if type == 'project':
        request_data = get_object_or_404(ProjectRequest, pk=request_id)
    elif type == 'ipr':
        request_data = get_object_or_404(IPRRequest, pk=request_id)
    else:
        return render(request, '404.html')
    return render(request, 'college/request_details.html', {
        'request_data': request_data,
        'type': type
    })


@login_required
def delete_request(request, pk):
    if request.method == 'POST':
        try:
            obj = ProjectRequest.objects.get(pk=pk)
        except ProjectRequest.DoesNotExist:
            obj = get_object_or_404(IPRRequest, pk=pk)
        obj.delete()
        return render(request, 'request_delete_successfully.html')